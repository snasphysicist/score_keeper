<!DOCTYPE html>
<html lang="en">
<head>
  <title>Next Duel</title>
  <meta charset="UTF-8">
  <style type="text/css">
    body, h1, h2, p, input, div, select {
      background-color: black;
      color: white;
      margin: 5px;
      text-align: center;
      font-family: sans-serif;
    }
    input, select {
      min-width: 70%;
      min-height: 50px;
      font-family: sans-serif;
      text-align: center;
    }
    option {
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="vue">
    <h1>Next Duel</h1>
    <div>
      <p>Stage</p>
      <select v-model="selectedstage">
        <option v-for="stage in allStages" :stageid="stage.id">{% verbatim %}{{ stage.number }}{% endverbatim %}</option>
      </select>
      <p>Group</p>
      <select v-model="selectedgroup">
        <option v-for="group in stageGroups" :groupid="group.id">{% verbatim %}{{ group.number }}{% endverbatim %}</option>
      </select>
      <p>Duel</p>
      <select v-model="selectedduel">
        <option v-for="duel in groupDuels" :duelid="duel.id">{% verbatim %}{{ duel.opponent1 }} vs {{ duel.opponent2 }}{% endverbatim %}</option>
      </select>
    </div>
    <input type="button" id="fight" onclick="startNewDuel()" value="READY!"/>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- Set up Vue -->
  <script type="text/javascript">
    let vueApplication = new Vue({
      el: "#vue",
      data: {
        selectedstage: "",
        selectedgroup: "",
        selectedduel: "",
        pendingduels: {}
      },
      computed: {
        allStages: function() {
          if (this.pendingduels["stages"]) {
            return this.pendingduels["stages"];
          } else {
            return [];
          }
        },
        stageGroups: function() {
          // Get all groups for the selected stage
          if (!this.pendingduels["stages"]) {
            return [];
          }
          let stage = this.pendingduels["stages"].filter(function(stage) {
            return stage["stage"]["number"] == this.selectedstage;
          });
          if (stage.length == 0) {
            return [];
          }
          return stage[0]["groups"];
        },
        groupDuels: function() {
          if (!this.pendingduels["stages"]) {
            return [];
          }
          /*
           * Filter down to selected stage
           * Map to extract groups
           * Will then have array in array [[group1, group2, ...]]
           * So extract first element
           */
          let groups = this.pendingduels["stages"].filter(function(stage) {
            return stage["stage"]["number"] == this.selectedstage;
          }).map(function(stage) {
            return stage["groups"];
          })[0];
          if (!groups) {
            return [];
          }
          // Filter down to selected group
          let group = groups.filter(function(group) {
            return group["group"]["number"] == this.selectedgroup;
          })
          if (group.length == 0) {
            return [];
          }
          return group[0]["duels"];
        }
      }
    });
  </script>
  <script type="text/javascript">
    /*
     * When fetching a list of pending
     * duels, suggest which should be next
     */
    function setSuggestedNextDuel() {
      if (!pendingduels["stage"]) {
        return;
      }
      // Get stages/groups with duels
      let pendingStages = vueApplication.pendingduels["stages"].filter(function(stage) {
        let groups = stage["groups"].filter(function(group) {
          return group["duels"].length > 0;
        })
        return groups.length > 0;
      })
      if (pendingStages[0]) {
        let suggestedStage = pendingStages[0];
        let suggestedGroup = pendingStages[0]["groups"][0];
        let suggestedDuel = pendingStages[0]["groups"][0]["duels"][0];
        vueApplication.selectedstage = suggestedStage["stage"]["number"];
        vueApplication.selectedgroup = suggestedGroup["group"]["number"];
        vueApplication.selectedduel = suggestedDuel["opponent1"] + " vs "
          + suggestedDuel["opponent2"];
      }
    }
    // Fetch all pending duel details from api
    function fetchPendingDuels() {
      const GET_URL = "/run_duel/api/v1/pending_duels";
      fetch(
        GET_URL,
        {
          method: "GET"
        }
      ).then((response) => {
        if(response.ok) {
          return response.json();
        } else {
          // Handle error
        }
      }).then((json) => {
        if (json["success"]) {
          vueApplication.pendingduels = json["pending"];
          if (json["pending"].length > 0) {
            setTimeout(setSuggestedNextDuel, 100);
          }
        }
      });
    }
    fetchPendingDuels();
  </script>
  <!-- JS to submit form -->
  <script type="text/javascript">
    function startNewDuel() {
      const POST_URL = "/run_duel/api/v1/new_duel";
      // Need to find id of selected duel
      // Get all elements with duelid attribute
      let duels = document.querySelectorAll("option[duelid]");
      // Find inner html that matches selection
      let duelid;
      for (let i = 0; i < duels.length; i++) {
        let duel = duels[i];
        if (duel.innerText == vueApplication.selectedduel) {
          duelid = duel.getAttribute("duelid");
          break;
        }
      }
      let data = {
        "id": duelid
      };
      fetch(
        POST_URL,
        {
          method: "POST",
          body: JSON.stringify(data)
        }
      ).then((response) => {
          if(response.ok) {
            window.location.href = "/run_duel/current"
          } else {
            // Handle error
          }
      })
    }
  </script>
</body>
</html>
